{% extends "projectLeader/base.html" %}

{% block title %}Tasks{% endblock %}

{% block content %}
<div class="top-bar">
    <div class="search-container">
        <i class="fas fa-search text-muted"></i>
        <input type="text" id="searchTasks" placeholder="Search projects, tasks, or team members..."
            onkeyup="filterTasks()">
    </div>
    <div class="d-flex gap-3 align-items-center">
        <div class="notification-btn" data-bs-toggle="dropdown">
            <i class="fas fa-bell fa-lg"></i>
            <span class="notification-badge">3</span>
        </div>
        <div class="dropdown-menu dropdown-menu-end p-0"="min-width: 320px;" style>
            <div class="p-3 border-bottom">
                <h6 class="mb-0">Notifications</h6>
            </div>
            <div class="p-0">
                <div class="p-3 border-bottom">
                    <div class="d-flex">
                        <div class="user-avatar me-3" style="width: 36px; height: 36px; font-size: 0.9rem;">M</div>
                        <div>
                            <p class="mb-1"><strong>Mike Chen</strong> completed a task</p>
                            <small class="text-muted">30 minutes ago</small>
                        </div>
                    </div>
                </div>
                <div class="p-3 border-bottom">
                    <div class="d-flex">
                        <div class="user-avatar me-3"
                            style="width: 36px; height: 36px; font-size: 0.9rem; background: #f59e0b;">S</div>
                        <div>
                            <p class="mb-1"><strong>Sarah</strong> added a comment</p>
                            <small class="text-muted">2 hours ago</small>
                        </div>
                    </div>
                </div>
                <div class="p-3">
                    <div class="d-flex">
                        <div class="user-avatar me-3"
                            style="width: 36px; height: 36px; font-size: 0.9rem; background: #10b981;">A</div>
                        <div>
                            <p class="mb-1">Project <strong>Website Redesign</strong> milestone reached</p>
                            <small class="text-muted">1 day ago</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tasks Content -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold">Tasks</h2>
        <p class="text-muted mb-0">Manage all tasks across projects</p>
    </div>
    <button class="edit-btn px-4 py-2 rounded-pill" data-bs-toggle="modal" data-bs-target="#createTask">
        <i class="fas fa-plus me-2"></i>Create New Task
    </button>
</div>


<div>
    <div class="table-card">
        <h5 class="fw-bold mb-4">All Tasks</h5>

        <div class="table-container">
            <table class="custom-table" id="tasksTable">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Project</th>
                        <th>Assignee</th>
                        <th>Priority</th>
                        <th>Due Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if tasks and tasks|length > 0 %}
                    {% for task in tasks %}
                    <tr class="task-row priority-{{ task[3]|lower }}" data-task-id="{{ task[0] }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="task-avatar me-3">
                                    {{ task[7][0] if task[7] else 'T' }}
                                </div>
                                <div>
                                    <div class="task-title">{{ task[1] }}</div>
                                    <small class="task-description">{{ task[2][:50] + '...' if task[2] and task[2]|length >
                                    50 else task[2] }}</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ task[6] }}</td>
                        <td>{{ task[7] }}</td>
                        <td>
                            {% if task[3]|lower == 'high' %} <!-- Use |lower filter -->
                            <span class="priority-badge priority-high">{{ task[3] }}</span>
                            {% elif task[3]|lower == 'medium' %} <!-- Use |lower filter -->
                            <span class="priority-badge priority-medium">{{ task[3] }}</span>
                            {% elif task[3]|lower == 'low' %} <!-- Use |lower filter -->
                            <span class="priority-badge priority-low">{{ task[3] }}</span>
                            {% else %}
                            <span class="priority-badge">{{ task[3] }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task[5] %}
                            <span class="due-date {% if task[5] < now %}overdue{% endif %}">{{ task[5] }}</span>
                            {% else %}
                            <span class="text-muted">No date</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task[4] == 'approved' %}
                            <span class="status-badge" style="background: #d1fae5; color: #065f46;">Approved</span>
                            {% elif task[4] == 'submitted' %}
                            <span class="status-badge" style="background: #fef3c7; color: #92400e;">Pending
                                Review</span>
                            {% elif task[4] == 'in_progress' %}
                            <span class="status-badge" style="background: #dbeafe; color: #1e40af;">In Progress</span>
                            {% elif task[4] == 'rejected' %}
                            <span class="status-badge" style="background: #fee2e2; color: #991b1b;">Rejected</span>
                            {% else %}
                            <span class="status-badge">{{ task[4] }}</span>
                            {% endif %}
                        </td>
                        <td>
                        <td>
                            <div class="d-flex gap-2">
                                <!-- Show different actions based on status -->
                                {% if task[4] == 'submitted' %}
                                <button class="btn btn-sm btn-success approve-task" data-task-id="{{ task[0] }}"
                                    title="Approve Task">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                                <button class="btn btn-sm btn-danger reject-task" data-task-id="{{ task[0] }}"
                                    title="Reject Task">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                                {% elif task[4] == 'rejected' %}
                                <span class="badge bg-secondary me-2" title="Rejection reason: {{ task[8] }}">
                                    <i class="fas fa-info-circle"></i> Rejected
                                </span>
                                {% endif %}

                                <!-- Always show edit/delete -->
                                <button class="btn btn-sm btn-outline-primary edit-task" data-task-id="{{ task[0] }}"
                                    onclick="editTask({{ task[0] }})" title="Edit Task">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-task" data-task-id="{{ task[0] }}"
                                    data-task-name="{{ task[1] }}" title="Delete Task">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-5">
                            <div class="empty-state">
                                <i class="fas fa-tasks fa-3x mb-3"></i>
                                <p>No tasks found. Click "Create New Task" to add one.</p>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div>
    <div class="table-card mb-4">
        <h5 class="fw-bold mb-4">Task Summary</h5>
        <div class="activity-timeline">
            <div class="activity-item">
                <div class="activity-dot task"></div>
                <div>
                    <p class="mb-1"><strong>{{ task_summary[0] }} Tasks Completed</strong></p>
                    <small class="text-muted">This week</small>
                </div>
            </div>
            <div class="activity-item">
                <div class="activity-dot task"></div>
                <div>
                    <p class="mb-1"><strong>{{ task_summary[1] }} Tasks Overdue</strong></p>
                    <small class="text-muted">Need attention</small>
                </div>
            </div>
            <div class="activity-item">
                <div class="activity-dot task"></div>
                <div>
                    <p class="mb-1"><strong>{{ task_summary[2] }} Tasks In Progress</strong></p>
                    <small class="text-muted">Active tasks</small>
                </div>
            </div>
            <div class="activity-item">
                <div class="activity-dot task"></div>
                <div>
                    <p class="mb-1"><strong>{{ task_summary[3] }} Pending Review</strong></p>
                    <small class="text-muted">Awaiting approval</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Create Task Modal -->
<div class="modal fade" id="createTask" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Create New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="/projectleader/create_task">
                    <div class="mb-3">
                        <label class="form-label">Task Title</label>
                        <input type="text" name="title" class="form-control" placeholder="Enter task title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="3"
                            placeholder="Task description"></textarea>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Assignee</label>
                            <select name="assigned_to" class="form-select" required>
                                <option value="" selected>Select team member</option>
                                {% for u in users %}
                                <option value="{{ u[0] }}">{{ u[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Priority</label>
                            <select name="priority" class="form-select">
                                <option>Low</option>
                                <option selected>Medium</option>
                                <option>High</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Due Date</label>
                            <input type="date" name="due_date" class="form-control">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="edit-btn w-100 py-2">Create Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm" method="POST">
                    <div class="mb-3">
                        <label class="form-label">Task Title</label>
                        <input type="text" name="title" id="edit_title" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" id="edit_description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Assignee</label>
                            <select name="assigned_to" id="edit_assigned_to" class="form-select" required>
                                <option value="">Select team member</option>
                                {% for u in users %}
                                <option value="{{ u[0] }}">{{ u[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Project</label>
                            <select name="project_id" id="edit_project_id" class="form-select" required>
                                <option value="">Select project</option>
                                {% for p in projects %}
                                <option value="{{ p[0] }}">{{ p[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Priority</label>
                            <select name="priority" id="edit_priority" class="form-select">
                                <option>Low</option>
                                <option>Medium</option>
                                <option>High</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-12">
                            <label class="form-label">Due Date</label>
                            <input type="date" name="due_date" id="edit_due_date" class="form-control">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="edit-btn w-100 py-2">Update Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Delete Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-exclamation-triangle text-danger fa-3x mb-3"></i>
                <p class="mb-0">Are you sure you want to delete "<span id="deleteTaskName"></span>"?</p>
                <small class="text-muted">This action cannot be undone.</small>
            </div>
            <div class="modal-footer border-0 pt-0">
                <form id="deleteTaskForm" method="POST">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Approve Confirmation Modal -->
<div class="modal fade" id="approveTaskModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Approve Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                <p class="mb-0">Approve this task?</p>
                <small class="text-muted">Employee will be notified</small>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmApproveBtn">Approve</button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Task Modal with Reason -->
<div class="modal fade" id="rejectTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Reject Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Reason for rejection <span class="text-danger">*</span></label>
                    <textarea id="rejectionReason" class="form-control" rows="4"
                        placeholder="Explain why this task is being rejected..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmRejectBtn">Reject Task</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/projectLeader/main.js') }}"></script>
{% endblock %}