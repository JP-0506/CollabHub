{% extends "projectLeader/base.html" %}

{% block title %}My Team{% endblock %}

{% block content %}
<div class="top-bar">
    <div class="search-container">
        <i class="fas fa-search text-muted"></i>
        <input type="text" id="teamSearch" placeholder="Search team members..." onkeyup="filterTeam()">
    </div>
    <div class="d-flex gap-3 align-items-center">
        <div class="notification-btn" data-bs-toggle="dropdown">
            <i class="fas fa-bell fa-lg"></i>
            <span class="notification-badge">3</span>
        </div>
    </div>
</div>

<!-- Team Content -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold">My Team</h2>
        <p class="text-muted mb-0">Manage your team members and their assignments</p>
    </div>
    <button class="edit-btn px-4 py-2 rounded-pill" data-bs-toggle="modal" data-bs-target="#addMember">
        <i class="fas fa-user-plus me-2"></i>Add Member
    </button>
</div>

<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card text-center">
            <div class="stat-icon mx-auto" style="background: #e0f2fe; color: #0284c7;">
                <i class="fas fa-users"></i>
            </div>
            <span class="stat-value">{{ total_members }}</span>
            <span class="stat-label">Team Members</span>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card text-center">
            <div class="stat-icon mx-auto" style="background: #dcfce7; color: #16a34a;">
                <i class="fas fa-clock"></i>
            </div>
            <span class="stat-value">{{ active_now }}</span>
            <span class="stat-label">Active Now</span>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card text-center">
            <div class="stat-icon mx-auto" style="background: #fef9c3; color: #ca8a04;">
                <i class="fas fa-chart-line"></i>
            </div>
            <span class="stat-value">{{ avg_productivity }}</span>
            <span class="stat-label">Avg. Tasks/Member</span>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card text-center">
            <div class="stat-icon mx-auto" style="background: #ffe4e6; color: #e11d48;">
                <i class="fas fa-check-circle"></i>
            </div>
            <span class="stat-value">{{ on_time_rate }}%</span>
            <span class="stat-label">On-time Delivery</span>
        </div>
    </div>
</div>

<div class="table-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold mb-0">Team Members</h5>
        <div class="d-flex gap-2">
            <input type="text" id="tableSearch" class="form-control form-control-sm" placeholder="Search team..."
                onkeyup="filterTeamTable()" style="max-width: 200px;">
            <select class="form-select form-select-sm" id="roleFilter" onchange="filterByRole()"
                style="max-width: 150px;">
                <option value="">All Roles</option>
                <option value="Developer">Developer</option>
                <option value="Designer">Designer</option>
                <option value="Tester">Tester</option>
            </select>
        </div>
    </div>

    <div class="table-container">
        <table class="custom-table" id="teamTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Tasks</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="teamTableBody">
                {% if team and team|length > 0 %}
                {% for member in team %}
                {% set member_id = member[0] %}
                {% set task_count = task_counts.get(member_id, {'total': 0, 'completed': 0}) %}
                <tr class="team-member-row" data-name="{{ member[1]|lower }}" data-role="{{ member[3]|lower }}">
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="user-avatar me-3"
                                style="background: linear-gradient(135deg, {% if loop.index % 3 == 0 %}#6366f1{% elif loop.index % 3 == 1 %}#10b981{% else %}#f59e0b{% endif %} 0%, {% if loop.index % 3 == 0 %}#a855f7{% elif loop.index % 3 == 1 %}#34d399{% else %}#fbbf24{% endif %} 100%);">
                                {{ member[1][0] if member[1] else 'U' }}
                            </div>
                            <div>
                                <div class="fw-bold">{{ member[1] }}</div>
                                <small class="text-muted">{{ member[3] }}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="role-badge">{{ member[3] }}</span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <span class="fw-bold">{{ task_count.completed }}/{{ task_count.total }}</span>
                            {% if task_count.total > 0 %}
                            <div class="progress-container" style="width: 80px;">
                                <div class="progress-bar"
                                    style="width: {{ (task_count.completed / task_count.total * 100)|int if task_count.total > 0 else 0 }}%">
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="messageMember({{ member_id }})"
                                title="Send Message">
                                <i class="fas fa-comment"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary"
                                onclick="openMemberOverview({{ member_id }})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>

                            <button class="btn btn-sm btn-outline-danger"
                                onclick="removeMember({{ member_id }}, '{{ member[1] }}')" title="Remove from Team">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="4" class="text-center text-muted py-4">
                        <div class="empty-state">
                            <i class="fas fa-users fa-3x mb-3"></i>
                            <p>No team members found in your projects.</p>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="messageForm">
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" rows="4" id="messageText" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Send</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Remove Member Modal -->
<div class="modal fade" id="removeMemberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Remove Team Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="removeMemberMessage">Are you sure you want to remove <span id="removeMemberName"></span> from the
                    team?</p>
                <form id="removeMemberForm" method="POST" action="{{ url_for('project_leader.remove_team_member') }}">
                    <input type="hidden" name="user_id" id="removeUserId">
                    <button type="submit" class="btn btn-danger w-100">Remove</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Past Team Members -->
<div class="table-card mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold mb-0">
            <i class="fas fa-user-clock me-2 text-muted"></i>Past Team Members
        </h5>
        <span class="badge bg-secondary">{{ past_members|length }}</span>
    </div>

    {% if past_members %}
    <div class="table-container">
        <table class="custom-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Role in Project</th>
                    <th>Designation</th>
                    <th>Email</th>
                    <th>Joined On</th>
                </tr>
            </thead>
            <tbody>
                {% for member in past_members %}
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="user-avatar me-3"
                                style="background: linear-gradient(135deg, #6b7280, #9ca3af);">
                                {{ member[1][0] if member[1] else 'U' }}
                            </div>
                            <div>
                                <div class="fw-bold text-muted">{{ member[1] }}</div>
                                <small class="text-muted">{{ member[2] }}</small>
                            </div>
                        </div>
                    </td>
                    <td><span class="role-badge">{{ member[4] }}</span></td>
                    <td>{{ member[3] or '—' }}</td>
                    <td>{{ member[2] }}</td>
                    <td>
                        <small class="text-muted">
                            {{ member[5].strftime('%d %b %Y') if member[5] else '—' }}
                        </small>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center text-muted py-4">
        <i class="fas fa-user-slash fa-2x mb-2"></i>
        <p class="mb-0">No past team members.</p>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block modals %}
<!-- Add Member Modal -->
<div class="modal fade" id="addMember" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Add Team Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('project_leader.add_team_member') }}">
                    <div class="mb-3">
                        <label class="form-label">Select Employee</label>
                        <select name="user_id" class="form-select" required>
                            <option value="" selected hidden>Choose from company directory</option>
                            {% for employee in available_employees %}
                            <option value="{{ employee[0] }}">{{ employee[1] }} - {{ employee[2] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role in Project</label>
                        <input type="text" name="role" class="form-control" placeholder="e.g., Frontend Developer"
                            required>
                    </div>
                    <button type="submit" class="edit-btn w-100 py-2">Add to Team</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="memberOverviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Member Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <h6 class="fw-bold mb-3" id="m_name"></h6>

                <div class="row mb-2">
                    <div class="col-5">Email:</div>
                    <div class="col-7" id="m_email"></div>
                </div>

                <div class="row mb-2">
                    <div class="col-5">Designation:</div>
                    <div class="col-7" id="m_designation"></div>
                </div>

                <div class="row mb-2">
                    <div class="col-5">System Role:</div>
                    <div class="col-7" id="m_role"></div>
                </div>

                <div class="row mb-2">
                    <div class="col-5">Joined System:</div>
                    <div class="col-7" id="m_joined_system"></div>
                </div>

                <hr>
                <h6 class="fw-bold">Task Summary</h6>

                <div class="row mb-1">
                    <div class="col-6">Total:</div>
                    <div class="col-6" id="m_total"></div>
                </div>

                <div class="row mb-1 text-success">
                    <div class="col-6">Completed:</div>
                    <div class="col-6" id="m_completed"></div>
                </div>

                <div class="row mb-1 text-warning">
                    <div class="col-6">Pending:</div>
                    <div class="col-6" id="m_pending"></div>
                </div>

                <div class="row mb-2 text-danger">
                    <div class="col-6">Overdue:</div>
                    <div class="col-6" id="m_overdue"></div>
                </div>

                <div class="progress">
                    <div class="progress-bar" id="m_progress" style="width:0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block extra_js %}
<script src="{{ url_for('static', filename='js/projectLeader/main.js') }}"></script>
{% endblock %}